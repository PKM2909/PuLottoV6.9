<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PuLotto V1.75 DApp</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Nunito Sans font from Google Fonts - Clean, modern, and friendly aesthetic (for main app) -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Space Mono font from Google Fonts - For the burn tracker (digital/monospace style) -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito Sans', sans-serif;
            font-size: 0.875rem; /* Slightly smaller base font size (14px) */
            padding: 0.75rem; /* Reduced default padding for mobile */
            padding-top: 0.75rem;
            background: radial-gradient(circle at center, #1a2a2a 0%, #0a1a1a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden; /* Prevent horizontal scroll from animations */
        }
        /* Custom scrollbar for dark theme */
        .player-list::-webkit-scrollbar {
            width: 6px; /* Slightly thinner scrollbar */
        }
        .player-list::-webkit-scrollbar-track {
            background: #3f4757; /* Darker scrollbar track */
            border-radius: 10px;
        }
        .player-list::-webkit-scrollbar-thumb {
            background: #5a6270; /* Lighter scrollbar thumb */
            border-radius: 10px;
        }
        .player-list::-webkit-scrollbar-thumb:hover {
            background: #7a8391; /* Even lighter on hover */
        }
        /* Custom styling for details/summary to match theme */
        details {
            background-color: #4a5568;
            border-radius: 0.4rem; /* Slightly smaller border-radius */
            padding: 0.8rem; /* Reduced padding */
            margin-bottom: 0.8rem; /* Reduced margin */
            border: 1px solid #4a5568;
        }
        summary {
            font-weight: 600;
            color: #90EE90;
            cursor: pointer;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.1rem; /* Slightly smaller summary font */
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary::after {
            content: '+';
            font-size: 1.3rem; /* Adjusted icon size */
            transition: transform 0.2s;
            color: #90EE90;
        }
        details[open] summary::after {
            content: '-';
            transform: rotate(0deg);
        }
        details[open] summary {
            margin-bottom: 0.8rem; /* Reduced margin when open */
        }

        /* Styling for nested FAQ details */
        details.faq-item {
            background-color: #3f4757;
            border: 1px solid #3f4757;
            padding: 0.6rem; /* Reduced padding */
            margin-top: 0.4rem; /* Reduced margin */
            margin-bottom: 0.4rem; /* Reduced margin */
        }
        details.faq-item summary {
            font-weight: 500;
            color: #b0e0e6;
            font-size: 0.85rem; /* Slightly smaller for FAQ questions */
        }
        details.faq-item summary::after {
            font-size: 1.1rem; /* Adjusted icon size */
            color: #b0e0e6;
        }
        details.faq-item p {
            font-size: 0.8rem; /* Slightly smaller for FAQ answers */
            margin-top: 0.4rem; /* Reduced margin */
        }

        /* Responsive body padding */
        @media (min-width: 640px) { /* sm breakpoint */
            body {
                padding: 1.5rem; /* More padding on larger screens */
            }
        }
        /* Iframe specific styling - Increased height */
        .burn-tracker-iframe {
            width: 100%;
            height: 450px; /* Adjusted default height (was 700px) */
            border: none;
            border-radius: 0.5rem;
            background-color: #2d3748; /* Dark background for the iframe container */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .burn-tracker-iframe {
                height: 550px; /* Adjusted height on desktop (was 800px) */
            }
        }

        /* Popup Notification Styling */
        .popup-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #10B981; /* Green-5-00 for success */
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000; /* Ensure it's on top */
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            opacity: 0; /* Start hidden */
            visibility: hidden; /* Start hidden */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .popup-notification.show {
            opacity: 1;
            visibility: visible;
        }

        /* --- Tracker Specific Styles (Integrated and adapted) --- */
        .subtle-tracker-container {
            font-family: 'Space Mono', monospace; /* Use Space Mono for the tracker */
            background-color: #2d3748; /* Dark background for the tracker */
            border-radius: 0.6rem; /* Rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
            padding: 0.6rem 1rem; /* Reduced padding */
            margin-top: 0.75rem; /* Space from main title */
            margin-bottom: 1.5rem; /* Space before next section */
            color: #e2e8f0; /* Light text color */
            display: flex; /* Default to flex for the first container */
            flex-direction: column; /* Stacked on mobile */
            gap: 0.4rem; /* Smaller gap between lines */
            align-items: center;
            width: 100%;
            font-size: 0.75rem; /* Base font size for tracker - Adjusted for smaller fit */
        }
        /* Specific grid styling for the second tracker container */
        .grid-tracker-container {
            display: grid;
            grid-template-columns: 1fr; /* Single column on mobile */
            gap: 0.5rem; /* Gap between items */
            padding: 0.6rem 1rem; /* Match padding */
            margin-top: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: #2d3748;
            border-radius: 0.6rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: #e2e8f0;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }

        @media (min-width: 640px) { /* sm breakpoint */
            .subtle-tracker-container {
                flex-direction: row; /* Horizontal on desktop */
                justify-content: center;
                gap: 1.5rem; /* More space horizontally */
                font-size: 0.85rem; /* Slightly larger on desktop - Adjusted for smaller fit */
            }
            .grid-tracker-container {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on desktop */
                gap: 1rem; /* Adjust gap for desktop grid */
                font-size: 0.85rem;
            }
        }

        .tracker-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .tracker-label {
            font-weight: 600;
            color: #cbd5e0;
        }
        .tracker-value {
            font-weight: 700;
            color: #ffffff;
        }
        .tracker-usd-value {
            font-weight: 500;
            color: #a0aec0; /* Muted USD color */
            font-size: 0.7rem; /* Smaller USD font - Adjusted for smaller fit */
        }
        .tracker-usd-value.green { /* New style for green USD value */
            color: #6EE7B7; /* Tailwind green-400 equivalent */
        }
        @media (min-width: 640px) {
            .tracker-usd-value {
                font-size: 0.75rem; /* Adjusted for smaller fit */
            }
        }

        /* Spinner for loading states */
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-left-color: #68d391;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.3rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Transaction Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above popups */
            color: white;
            font-size: 1.2rem;
            text-align: center;
            visibility: hidden; /* Hidden by default */
            opacity: 0; /* Hidden by default */
            transition: visibility 0s, opacity 0.3s linear;
        }
        .loading-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .loading-spinner-large {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #10B981; /* Green color */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* --- Lottery Visualization Specific Styles (Merged and Adapted) --- */
        .ball-area {
            position: relative;
            width: 100%;
            height: 250px; /* Increased height for more movement */
            border: 2px dashed #4a5568; /* Matching PuLotto border style */
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            background-color: #1a2a2a; /* Inner background matching body start */
        }
        .ball {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex; /* For centering the inner span */
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.4);
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            will-change: transform;
            overflow: hidden; /* Ensure inner content stays within bounds */
        }

        /* New .ball-content for the inner circle and text */
        .ball-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80%; /* Size of the inner circle relative to the ball */
            height: 80%;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.8rem;
            word-break: break-all;
            line-height: 1;
            text-align: center;
            padding: 5px; /* Padding for the text inside the inner circle */
        }
        
        /* Multi-colored ball styles */
        .ball.color-0 { /* Red */
            background: linear-gradient(135deg, #FF6B6B, #E63946);
        }
        .ball.color-0 .ball-content {
            background-color: white;
            color: #333;
        }

        .ball.color-1 { /* Blue */
            background: linear-gradient(135deg, #6B94FF, #4A70D6);
        }
        .ball.color-1 .ball-content {
            background-color: white;
            color: #333;
        }

        .ball.color-2 { /* Yellow */
            background: linear-gradient(135deg, #FFE66B, #FFD100);
        }
        .ball.color-2 .ball-content {
            background-color: #333; /* Dark inner for yellow contrast */
            color: white;
        }

        .ball.color-3 { /* Green */
            background: linear-gradient(135deg, #6BFF6B, #4CAF50);
        }
        .ball.color-3 .ball-content {
            background-color: white;
            color: #333;
        }

        .ball.color-4 { /* Orange */
            background: linear-gradient(135deg, #FFB36B, #FF8C00);
        }
        .ball.color-4 .ball-content {
            background-color: white;
            color: #333;
        }

        .ball.color-5 { /* Purple */
            background: linear-gradient(135deg, #B36BFF, #8A2BE2);
        }
        .ball.color-5 .ball-content {
            background-color: white;
            color: #333;
        }

        .winner-ball {
            background: linear-gradient(135deg, #6EE7B7, #34D399); /* Bright green gradient from PuLotto */
            color: #1a2a2a; /* Dark text for contrast on bright green winner ball */
            width: 120px;
            height: 120px;
            font-size: 1.2rem;
            margin: 0 auto;
            transform: scale(0);
            opacity: 0;
            animation: popIn 0.5s forwards;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .winner-ball .address {
            font-size: 1.1rem;
            font-weight: bold;
            word-break: break-all;
        }
        .winner-ball .prize {
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: 600;
        }

        /* Text colors to match PuLotto DApp */
        .lottery-container h2 {
            color: #90EE90; /* Green accent for headings */
        }
        .lottery-container p {
            color: #cbd5e0; /* Light grey for general text */
        }
        #visualizationMessage { /* Renamed from #message to avoid conflict */
            color: #b0e0e6; /* Slightly lighter blue-grey for messages */
        }
        #winnerDisplay p {
            color: #6EE7B7; /* Brighter green for winner message */
        }

        /* Keyframes for continuous bouncing */
        @keyframes bounce {
            0% { transform: translate(var(--x), var(--y)); }
            100% { transform: translate(var(--target-x), var(--target-y)); }
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
    <!-- Using unpkg for better reliability for ethers.js -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">
    <div class="container bg-gray-800 p-3 sm:p-6 rounded-xl shadow-lg w-full max-w-3xl border border-gray-700 relative">
        <div class="text-center mb-4"> <!-- Reduced mb -->
            <div class="flex items-center justify-center mb-1"> <!-- Reduced mb -->
                <img src="https://chadpu.carrd.co/assets/images/image28.png?v=5428f06c" onerror="this.onerror=null;this.src='https://placehold.co/60x60/333/fff?text=CHDPU';" alt="CHDPU Logo" class="h-10 w-auto mr-2 sm:h-14 sm:mr-3 object-contain"> <!-- Reduced logo size -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-green-400">PuLotto V1.75 ðŸŽ²</h1> <!-- Updated Version -->
            </div>
            <div class="flex items-center justify-center text-sm sm:text-lg text-gray-300"> <!-- Reduced text size -->
                <p class="mr-1 sm:mr-2">Play with</p>
                <img src="https://chadpu.carrd.co/assets/images/image27.png?v=5428f06c" onerror="this.onerror=null;this.src='https://placehold.co/32x32/333/fff?text=TARA';" alt="TARA Logo" class="h-7 w-auto mr-1 sm:h-9 sm:mr-2 object-contain"> <!-- Reduced logo size -->
                <p>and win big!</p>
            </div>
        </div>

        <!-- Subtle CHDPU Burn Tracker at Header -->
        <div class="subtle-tracker-container">
            <div class="tracker-item border-r border-gray-600 pr-2 sm:pr-4"> <!-- Added border-r for spacer -->
                <span class="tracker-label">CHDPU Price:</span>
                <span id="headerChdpuPrice" class="tracker-value">Loading...</span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">Total Burned:</span>
                <span id="headerCumulativeChdpu" class="tracker-value">Loading...</span>
                <span id="headerCumulativeUsd" class="tracker-usd-value green"></span>
            </div>
        </div>

        <!-- Community Links Section - Updated Styling and Order -->
        <section class="mb-5 sm:mb-7 text-center"> <!-- Reduced mb -->
            <div class="flex flex-wrap justify-center gap-1.5 sm:gap-3 text-xs sm:text-sm font-medium"> <!-- Reduced gap -->
                <!-- Green Tiles -->
                <a href="https://t.me/CHADPUofficial" target="_blank" class="bg-[#16AB5A] text-white font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-[#138E49] transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">Join CHDPU</a>
                <a href="https://x.com/ChadPuOfficial" target="_blank" class="bg-[#16AB5A] text-white font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-[#138E49] transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">Follow CHDPU</a>
                
                <!-- Buy CHDPU - Middle Tile, White with Green Text -->
                <a href="https://fomo.biz/dex/swap?inputCurrency=TARA&outputCurrency=0xaad94Afea296DCF8c97D05dbf3733A245c3Ea78F" target="_blank" class="bg-white text-[#16AB5A] font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-gray-300 transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">Buy CHDPU</a>
                
                <!-- Green Tiles -->
                <a href="https://chadpu.carrd.co/" target="_blank" class="bg-[#16AB5A] text-white font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-[#138E49] transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">What is CHDPU?</a>
                <!-- Updated: Burn Tracker link now scrolls to section and has new text -->
                <a href="#burnTrackerSection" class="bg-[#16AB5A] text-white font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-[#138E49] transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">CHDPU Burn and Rewards Tracker</a>
                <!-- New: Results of Last Draw Button (now a scroll link) -->
                <a href="#pastWinnersList" id="resultsOfLastDrawBtn" class="bg-blue-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-lg border-b-4 border-r-4 border-blue-800 transition duration-200 ease-in-out active:translate-y-0.5 active:shadow-sm">Results of Last Draw</a>
            </div>
        </section>

        <!-- NEW 2x2 GRID FOR LOTTERY STATS -->
        <div class="grid-tracker-container mt-4 mb-4">
            <div class="tracker-item"> 
                <span class="tracker-label">PuLotto Prizes Won:</span>
                <span id="cumulativeTaraPrizes" class="tracker-value">0.0 TARA</span>
                <span id="cumulativeTaraPrizesUsd" class="tracker-usd-value green"></span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">Last Prize:</span>
                <span id="lastPrizeAmount" class="tracker-value">N/A</span>
                <span id="lastPrizeWinner" class="tracker-usd-value"></span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">Current Prize Pool:</span>
                <span id="currentPrizePool" class="tracker-value">0.0 TARA</span>
                <span id="currentPrizePoolUsd" class="tracker-usd-value green"></span>
            </div>
            <div class="tracker-item">
                <span class="tracker-label">Next Draw:</span>
                <span id="countdownTimer" class="tracker-value">Calculating...</span>
            </div>
            <div id="chdpuRewardsSection" class="tracker-item flex-col sm:flex-row items-center" style="display: none;">
                <span class="tracker-label">CHDPU Rewards Sent:</span>
                <span id="chdpuRewardsSent" class="tracker-value">0.0 CHDPU</span>
            </div>
        </div>

        <!-- What Is PuLotto? Section - Now Expandable with FAQ -->
        <details class="mb-6 p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600"> <!-- Reduced mb and p -->
            <summary class="text-xl font-semibold text-green-400">What Is PuLotto?</summary> <!-- Reduced text size -->
            <p class="text-gray-300 font-light mt-3 mb-3 text-sm"> <!-- Reduced mt, mb, and text size -->
                <span class="font-medium">PuLotto</span> is a community-focused lottery built on Taraxa, paid in <span class="font-medium">$TARA</span>. Anyone can play, with one winner taking the pot.
            </p>

            <details class="faq-item">
                <summary>What's the fee?</summary>
                <p class="text-gray-300 font-light">
                    A <span class="font-medium">12%</span> developer fee is applied to each round's prize pool. This fee is broken down as follows:
                    <ul class="list-disc list-inside ml-3 mt-1.5 text-gray-400 text-xs"> <!-- Reduced ml, mt, and text size -->
                        <li><span class="font-medium">6%</span>: Buy Back and Burn</li>
                        <li><span class="font-medium">6%</span>: Creator Fee</li>
                    </ul>
                </p>
            </details>

            <details class="faq-item">
                <summary>What does the fee go toward?</summary>
                <p class="text-gray-300 font-light">
                    This fee fuels the CHDPU ecosystem through a 6% portion dedicated to direct buy & burn, contributing to the deflationary nature of $CHDPU. The remaining 6% is allocated as a creator fee, supporting ongoing development, maintenance, and future marketing initiatives for the PuLotto platform and the broader CHDPU community. This creates a sustainable loop that grows <span class="font-medium">$CHDPU</span> organically and keeps Taraxa volume thriving.
                </p>
            </details>

            <details class="faq-item">
                <summary>How is the winner picked?</summary>
                <p class="text-gray-300 font-light">
                    The winner is picked using a pseudo-random number generated from the blockchain's `block.timestamp` (the time the block was mined) and the total number of tickets sold.
                </p>
            </details>

            <!-- New FAQ Item: How do I get rewarded for playing? - UPDATED ARTICULATION -->
            <details class="faq-item">
                <summary>How do I get rewarded for playing?</summary>
                <p class="text-gray-300 font-light mt-1.5 mb-2 text-xs">
                    As a token of appreciation for every non-winning ticket, players will receive a reward equivalent to **50% of the $CHDPU burn amount** associated with each ticket. These rewards are distributed from the developer's personal $CHDPU wallet immediately after a winner is drawn, aiming to further enhance $CHDPU holder distribution.
                </p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-800 rounded-md text-xs text-gray-200">
                        <thead>
                            <tr class="bg-gray-700 text-green-300">
                                <th class="py-1.5 px-2 text-left">Scenario</th>
                                <th class="py-1.5 px-2 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-1.5 px-2 border-b border-gray-600">1 Ticket Cost</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">1750 TARA</td>
                            </tr>
                            <tr>
                                <td class="py-1.5 px-2 border-b border-gray-600">6% TARA for Burn (per ticket)</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">105 TARA</td>
                            </tr>
                            <tr class="font-bold text-green-300">
                                <td class="py-1.5 px-2">Reward (0.5X Burn Amount)</td>
                                <td class="py-1.5 px-2 text-right">~52.5 TARA worth of $CHDPU</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>

            <!-- Updated: Fee Distribution Example Table -->
            <details class="faq-item">
                <summary>Fee Distribution Example (100 Tickets Sold)</summary>
                <p class="text-gray-300 font-light mt-1.5 mb-2 text-xs"> <!-- Reduced mt, mb, and text size -->
                    Assuming 100 tickets are sold at <span class="font-medium">1750 TARA</span> per ticket, the distribution would be:
                </p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-800 rounded-md text-xs text-gray-200"> <!-- Reduced text size -->
                        <thead>
                            <tr class="bg-gray-700 text-green-300">
                                <th class="py-1.5 px-2 text-left">Category</th> <!-- Reduced py, px -->
                                <th class="py-1.5 px-2 text-right">Amount (TARA)</th>
                                <th class="py-1.5 px-2 text-right">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-1.5 px-2 border-b border-gray-600">Total Pool</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">175,000</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">100%</td>
                            </tr>
                            <tr>
                                <td class="py-1.5 px-2 border-b border-gray-600">$CHDPU Buy Back and Burn</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">10,500</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">6%</td>
                            </tr>
                            <tr>
                                <td class="py-1.5 px-2 border-b border-gray-600">Creator Fee</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">10,500</td>
                                <td class="py-1.5 px-2 border-b border-gray-600 text-right">6%</td>
                            </tr>
                            <tr class="font-bold text-green-300">
                                <td class="py-1.5 px-2">Winner's Share</td>
                                <td class="py-1.5 px-2 text-right">154,000</td>
                                <td class="py-1.5 px-2 text-right">88%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>

            <details class="faq-item">
                <summary>Will there be a lottery in $CHDPU?</summary>
                <p class="text-gray-300 font-light">
                    Yes, in future versions. This is one of many upgrades and benefits to CHDPU holders going forward.
                </p>
            </details>
        </details>

        <section class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600"> <!-- Reduced mb and p -->
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">Wallet Connection</h2>
            <!-- Moved status message here -->
            <div id="statusMessage" class="status bg-blue-900 border-l-4 border-blue-600 text-blue-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm"> <!-- Reduced padding and font size -->
                Connect your wallet to get started.
            </div>
            <div id="walletConnectSection">
                <button id="connectWalletBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 sm:py-2.5 sm:px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-sm"> <!-- Reduced button padding and font size -->
                    Connect your wallet
                </button>
                <p class="mt-2.5 sm:mt-3 text-gray-300 text-sm">Connected Account: <span id="accountAddress" class="font-medium text-green-300 text-xs sm:text-sm break-all">Not Connected</span></p> <!-- Reduced mt, and text size -->
                <p class="text-gray-300 text-sm">Network ID: <span id="networkId" class="font-medium text-green-300 text-xs sm:text-sm"></span></p> <!-- Reduced text size -->
            </div>
            <div id="connectedAccountDisplay" class="hidden mt-2.5 sm:mt-3 text-center"> <!-- Reduced mt -->
                <p class="text-gray-300 text-base sm:text-lg font-medium">Connected Account:</p> <!-- Reduced text size -->
                <p class="font-bold text-green-300 text-sm sm:text-base break-all" id="connectedAddressText"></p> <!-- Reduced text size -->
                <p class="text-gray-300 text-xs">Network ID: <span id="connectedNetworkIdText" class="font-medium text-green-300 text-xs sm:text-sm"></span></p> <!-- Reduced text size -->
            </div>
        </section>

        <section class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600"> <!-- Reduced mb and p -->
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">Lottery Details</h2>
            <!-- Updated: Grid layout for two columns -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-gray-300 text-sm">
                <p class="font-medium">Lottery ID: <span id="lotteryId" class="font-bold text-green-300">Loading...</span></p>
                <p class="font-medium">Lottery Status: <span id="lotteryStatus" class="font-bold text-green-300">Loading...</span></p> <!-- New Status Display -->
                <p class="font-medium">TARA for Next CHDPU Burn: <span id="burnAmount" class="font-bold text-green-300">Loading...</span> TARA</p>
                <p class="font-medium">Ticket Price: <span id="ticketPrice" class="font-bold text-green-300">Loading...</span> TARA</p>
                <p class="font-medium">Winner of Last Round: <span id="currentWinner" class="font-bold text-green-300 text-xs sm:text-sm break-all">N/A</span> <span id="currentWinnerAmount" class="font-bold text-green-300 text-xs sm:text-sm"></span></p>
                <p class="font-medium">Prize Pool: <span id="prizePool" class="font-bold text-green-300">Loading...</span> TARA</p>
                <p class="font-medium">Current Tickets Sold: <span id="numPlayers" class="font-bold text-green-300">Loading...</span></p>
            </div>
            <button id="refreshDetailsBtn" class="mt-3 sm:mt-5 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm"> <!-- Reduced mt, padding, and font size -->
                Refresh Details
            </button>
        </section>

        <!-- Lottery Action Section (Enter and Pick Winner) -->
        <section class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">Lottery Actions</h2>

            <!-- Enter Lottery -->
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-green-300 mb-2">Buy Tickets</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="number" id="numTicketsInput" min="1" max="10" value="1" placeholder="Number of Tickets (1-10)" class="flex-grow p-2 rounded-md bg-gray-600 text-white border border-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="enterLotteryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Buy Ticket(s)
                    </button>
                </div>
            </div>

            <!-- Pick Winner (Owner Only) -->
            <div>
                <h3 class="text-lg font-semibold text-green-300 mb-2">Admin Actions</h3>
                <button id="pickWinnerBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Pick Winner (Owner Only)
                </button>
                <button id="startNewRoundBtn" class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Start New Round (Owner Only)
                </button>
                <button id="collectFeesBtn" class="w-full mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Collect Owner Fees (Owner Only)
                </button>
            </div>
        </section>

        <!-- Lottery Visualization Section -->
        <section class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600 lottery-container">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">Lottery Visualization</h2>
            <div id="ballArea" class="ball-area">
                <p id="visualizationMessage" class="absolute inset-0 flex items-center justify-center text-lg text-gray-400">Waiting for players...</p>
            </div>
            <div id="winnerDisplay" class="text-center mt-4">
                <!-- Winner will be displayed here -->
            </div>
        </section>

        <!-- Past Winners List Section -->
        <section id="pastWinnersList" class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">Past Winners</h2>
            <div id="pastWinnersContainer" class="player-list max-h-64 overflow-y-auto">
                <p class="text-gray-400" id="noPastWinnersMessage">No past winners to display yet.</p>
            </div>
        </section>

        <!-- CHDPU Burn and Rewards Tracker Section (Scroll Target) -->
        <section id="burnTrackerSection" class="mb-6 p-4 sm:p-5 bg-gray-700 rounded-lg shadow-md border border-gray-600">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-3 sm:mb-4">CHDPU Burn and Rewards Tracker</h2>
            <p class="text-gray-300 mb-4">This section would display detailed CHDPU burn and reward data. For this example, we'll use a placeholder iframe or dynamic content.</p>
            <!-- Placeholder for a more detailed burn tracker, or dynamically loaded content -->
            <iframe class="burn-tracker-iframe" src="https://placehold.co/600x450/2d3748/e2e8f0?text=CHDPU+Burn+Tracker+Content" title="CHDPU Burn Tracker"></iframe>
        </section>

    </div>

    <!-- Popup Notification -->
    <div id="popupNotification" class="popup-notification"></div>

    <!-- Transaction Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner-large"></div>
        <p id="loadingMessage">Processing transaction...</p>
    </div>

    <script>
        // --- Ethers.js and Contract Setup ---
        // Declare constants before they are used
        const TARAXA_MAINNET_CHAIN_ID = '0x349'; // Hex for 841 (Taraxa Mainnet)
        const TARAXA_MAINNET_RPC_URL = 'https://rpc.mainnet.taraxa.io/';

        // Initialize provider with RPC URL by default for view calls
        let provider = new ethers.providers.JsonRpcProvider(TARAXA_MAINNET_RPC_URL);
        let signer;
        let lotteryContract;
        let currentAccount = null;
        let contractOwnerAddress = null; // To store the contract owner's address
        

        // IMPORTANT: REPLACE WITH YOUR ACTUAL DEPLOYED CONTRACT ADDRESS
        const CONTRACT_ADDRESS = "0xd5464ffe27c6d0ad77b565b12da7a131f3ac4e03"; 

        // IMPORTANT: REPLACE WITH YOUR FULL CONTRACT ABI
        // This is the complete ABI for the PuLotto contract you provided.
        const CONTRACT_ABI = [
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_initialTicketPrice", "type": "uint256" },
                    { "internalType": "uint256", "name": "_ownerFeePercent", "type": "uint256" },
                    { "internalType": "uint256", "name": "_initialRoundDurationSeconds", "type": "uint256" }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": false, "internalType": "uint256", "name": "_roundEndTime", "type": "uint256" },
                    { "indexed": false, "internalType": "uint256", "name": "_durationSeconds", "type": "uint256" }
                ],
                "name": "LotteryRoundStarted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "_amount", "type": "uint256" }
                ],
                "name": "OwnerFeeCollected",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_player", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_amount", "type": "uint256" }
                ],
                "name": "RefundIssued",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" }
                ],
                "name": "RoundFullyRefunded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_player", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_numTickets", "type": "uint256" },
                    { "indexed": false, "internalType": "uint256", "name": "_totalAmount", "type": "uint256" }
                ],
                "name": "TicketPurchased",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "uint256", "name": "_lotteryId", "type": "uint256" },
                    { "indexed": true, "internalType": "address", "name": "_winner", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "_prizeAmount", "type": "uint256" }
                ],
                "name": "WinnerPicked",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "BURN_ADDRESS",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "REFUND_GRACE_PERIOD_SECONDS",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "canStartNewRound",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "collectOwnerFees",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentRoundDurationSeconds",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "currentWinner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "_numTickets", "type": "uint256" }],
                "name": "enter",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractTARABalance",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getIsOpenForEntries",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPlayers",
                "outputs": [{ "internalType": "address[]", "name": "", "type": "address[]" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "isAcceptingEntries",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "lotteryId",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ownerFeePercentage",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ownerFeesCollected",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "pickWinner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "_lotteryId", "type": "uint256" }],
                "name": "processUndrawnRefunds",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "roundEndTime",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "name": "roundEndTimes",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "name": "roundRefunded",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "_newFeePercent", "type": "uint256" }],
                "name": "setOwnerFeePercentage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "_newPrice", "type": "uint256" }],
                "name": "setTicketPrice",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "_roundDurationSeconds", "type": "uint256" }],
                "name": "startNewRound",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "ticketPrice",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "address", "name": "", "type": "address" }],
                "name": "totalDepositsPerLottery",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "name": "winners",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            { "stateMutability": "payable", "type": "receive" },
            { "stateMutability": "payable", "type": "fallback" }
        ];


        // --- UI Elements ---
        const statusMessage = document.getElementById('statusMessage');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const accountAddressSpan = document.getElementById('accountAddress');
        const networkIdSpan = document.getElementById('networkId');
        const connectedAccountDisplay = document.getElementById('connectedAccountDisplay');
        const connectedAddressText = document.getElementById('connectedAddressText');
        const connectedNetworkIdText = document.getElementById('connectedNetworkIdText');

        const lotteryIdSpan = document.getElementById('lotteryId');
        const lotteryStatusSpan = document.getElementById('lotteryStatus');
        const burnAmountSpan = document.getElementById('burnAmount');
        const ticketPriceSpan = document.getElementById('ticketPrice');
        const currentWinnerSpan = document.getElementById('currentWinner');
        const currentWinnerAmountSpan = document.getElementById('currentWinnerAmount');
        const prizePoolSpan = document.getElementById('prizePool');
        const numPlayersSpan = document.getElementById('numPlayers');
        const refreshDetailsBtn = document.getElementById('refreshDetailsBtn');

        const numTicketsInput = document.getElementById('numTicketsInput');
        const enterLotteryBtn = document.getElementById('enterLotteryBtn');
        const pickWinnerBtn = document.getElementById('pickWinnerBtn');
        const startNewRoundBtn = document.getElementById('startNewRoundBtn');
        const collectFeesBtn = document.getElementById('collectFeesBtn');

        const headerChdpuPrice = document.getElementById('headerChdpuPrice');
        const headerCumulativeChdpu = document.getElementById('headerCumulativeChdpu');
        const headerCumulativeUsd = document.getElementById('headerCumulativeUsd');
        const cumulativeTaraPrizes = document.getElementById('cumulativeTaraPrizes');
        const cumulativeTaraPrizesUsd = document.getElementById('cumulativeTaraPrizesUsd');
        const lastPrizeAmount = document.getElementById('lastPrizeAmount');
        const lastPrizeWinner = document.getElementById('lastPrizeWinner');
        const currentPrizePool = document.getElementById('currentPrizePool');
        const currentPrizePoolUsd = document.getElementById('currentPrizePoolUsd');
        const countdownTimer = document.getElementById('countdownTimer');
        const chdpuRewardsSent = document.getElementById('chdpuRewardsSent');
        const chdpuRewardsSection = document.getElementById('chdpuRewardsSection');

        const popupNotification = document.getElementById('popupNotification');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');

        const ballArea = document.getElementById('ballArea');
        const visualizationMessage = document.getElementById('visualizationMessage');
        const winnerDisplay = document.getElementById('winnerDisplay');
        const pastWinnersContainer = document.getElementById('pastWinnersContainer');
        const noPastWinnersMessage = document.getElementById('noPastWinnersMessage');


        // --- Price & Formatting ---
        let TARA_USD_PRICE = 0.00271349; // Default/fallback price
        let CHDPU_USD_PRICE = 0.000000001; // Placeholder, fetch real price

        function formatTARA(amountWei) {
            if (!amountWei) return '0.0';
            return ethers.utils.formatEther(amountWei);
        }

        function formatUSD(taraAmount) {
            if (TARA_USD_PRICE === 0) return '';
            const usdValue = parseFloat(taraAmount) * TARA_USD_PRICE;
            return `($${usdValue.toFixed(4)})`;
        }

        function formatCHDPU(amountWei) {
            if (!amountWei) return '0.0';
            // Assuming CHDPU also has 18 decimals like TARA for simplicity, adjust if different
            return ethers.utils.formatEther(amountWei);
        }

        function formatCHDPUUSD(chdpuAmount) {
            if (CHDPU_USD_PRICE === 0) return '';
            const usdValue = parseFloat(chdpuAmount) * CHDPU_USD_PRICE;
            return `($${usdValue.toFixed(8)})`;
        }

        function shortenAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // --- UI Feedback Functions ---
        function showLoadingOverlay(message = "Processing transaction...") {
            loadingMessage.textContent = message;
            loadingOverlay.classList.add('show');
        }

        function hideLoadingOverlay() {
            loadingOverlay.classList.remove('show');
        }

        function showNotification(message, type = 'success') {
            popupNotification.textContent = message;
            popupNotification.className = 'popup-notification show'; // Reset classes
            if (type === 'success') {
                popupNotification.style.backgroundColor = '#10B981'; // Green
            } else if (type === 'error') {
                popupNotification.style.backgroundColor = '#EF4444'; // Red
            } else {
                popupNotification.style.backgroundColor = '#3B82F6'; // Blue
            }
            setTimeout(() => {
                popupNotification.classList.remove('show');
            }, 3000);
        }

        // --- Wallet Connection ---
        async function connectWallet() {
            showLoadingOverlay("Connecting wallet...");
            try {
                if (typeof window.ethereum !== 'undefined') {
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0];

                    // Reassign global provider to Web3Provider
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();

                    // Get network details
                    const network = await provider.getNetwork();
                    const chainId = '0x' + network.chainId.toString(16); // Convert to hex string

                    if (chainId !== TARAXA_MAINNET_CHAIN_ID) {
                        statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                        statusMessage.textContent = `Please connect your wallet to Taraxa Mainnet (Chain ID: ${parseInt(TARAXA_MAINNET_CHAIN_ID, 16)}). You are currently on Chain ID: ${network.chainId}.`;
                        // Optionally, prompt user to switch network
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: TARAXA_MAINNET_CHAIN_ID }],
                            });
                            // If switch is successful, on 'chainChanged' event will re-initialize
                        } catch (switchError) {
                            console.error("Failed to switch network:", switchError);
                            // User rejected network switch or network not added
                        }
                        hideLoadingOverlay();
                        return;
                    }

                    // Initialize the contract with signer for write operations
                    lotteryContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    // Get contract owner address
                    contractOwnerAddress = await lotteryContract.owner();

                    statusMessage.className = 'status bg-green-900 border-l-4 border-green-600 text-green-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                    statusMessage.textContent = "Wallet connected successfully to Taraxa Mainnet!";
                    accountAddressSpan.textContent = shortenAddress(currentAccount);
                    networkIdSpan.textContent = network.chainId;

                    connectedAddressText.textContent = currentAccount;
                    connectedNetworkIdText.textContent = network.chainId;
                    connectedAccountDisplay.classList.remove('hidden');
                    connectWalletBtn.style.display = 'none'; // Hide connect button

                    // Enable/Disable buttons based on connection and owner status
                    enterLotteryBtn.disabled = false;
                    if (currentAccount && contractOwnerAddress && currentAccount.toLowerCase() === contractOwnerAddress.toLowerCase()) {
                        pickWinnerBtn.disabled = false;
                        startNewRoundBtn.disabled = false;
                        collectFeesBtn.disabled = false;
                        statusMessage.textContent += " (You are the contract owner!)";
                    } else {
                        pickWinnerBtn.disabled = true;
                        startNewRoundBtn.disabled = true;
                        collectFeesBtn.disabled = true;
                    }

                    await updateUI(); // Refresh all DApp data

                } else {
                    statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                    statusMessage.textContent = "MetaMask or other wallet extension not detected. Please install one.";
                }
            } catch (error) {
                console.error("Error connecting wallet:", error);
                statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                statusMessage.textContent = `Failed to connect wallet: ${error.message}`;
            } finally {
                hideLoadingOverlay();
            }
        }

        // --- Event Listeners for Wallet Changes ---
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    connectWallet(); // Re-run connection logic to update UI and contract instance
                } else {
                    // User disconnected all accounts
                    currentAccount = null;
                    // Reset provider to JsonRpcProvider for view calls
                    provider = new ethers.providers.JsonRpcProvider(TARAXA_MAINNET_RPC_URL);
                    signer = null;
                    lotteryContract = null; // Will be re-initialized by updateUI
                    contractOwnerAddress = null;
                    accountAddressSpan.textContent = 'Not Connected';
                    networkIdSpan.textContent = '';
                    connectedAddressText.textContent = '';
                    connectedNetworkIdText.textContent = '';
                    connectedAccountDisplay.classList.add('hidden');
                    connectWalletBtn.style.display = 'block'; // Show connect button
                    statusMessage.className = 'status bg-blue-900 border-l-4 border-blue-600 text-blue-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                    statusMessage.textContent = "Wallet disconnected. Connect your wallet to get started.";
                    enterLotteryBtn.disabled = true;
                    pickWinnerBtn.disabled = true;
                    startNewRoundBtn.disabled = true;
                    collectFeesBtn.disabled = true;
                    updateUI(); // Clear DApp data
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log("Network changed to:", chainId);
                connectWallet(); // Re-run connection logic to check network and update UI
            });
        }

        // --- Fetch & Update DApp UI Data ---
        async function updateUI() {
            // Ensure lotteryContract is initialized with the correct provider/signer
            // If signer is available, use it; otherwise, use the default JsonRpcProvider
            lotteryContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer || provider);

            try {
                // Fetch current block timestamp
                let currentTimestamp;
                try {
                    const block = await provider.getBlock("latest");
                    currentTimestamp = block.timestamp;
                    console.log("Fetched current block timestamp:", currentTimestamp);
                } catch (blockError) {
                    console.error("Error fetching latest block timestamp:", blockError);
                    if (blockError.code === 'NETWORK_ERROR') {
                        statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                        statusMessage.textContent = `Network Error: Could not connect to Taraxa RPC. Please check your internet connection or try again later.`;
                        return; // Stop further execution if network is truly down
                    }
                    console.warn("Could not fetch latest block timestamp from RPC, falling back to local time. Error:", blockError);
                    currentTimestamp = Math.floor(Date.now() / 1000);
                    statusMessage.textContent = `Warning: Could not fetch real-time block data. Using local time. Error: ${blockError.message}`;
                    statusMessage.className = 'status bg-yellow-900 border-l-4 border-yellow-600 text-yellow-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                }

                // Fetch all contract state variables in parallel
                const [
                    lotteryId,
                    ticketPrice,
                    players,
                    contractCurrentWinner, // Renamed to avoid conflict with `currentWinner` for UI display
                    contractBalance,
                    isOpenForEntries,
                    roundEndTime,
                    ownerFeesCollected,
                    contractOwner
                ] = await Promise.all([
                    lotteryContract.lotteryId(),
                    lotteryContract.ticketPrice(),
                    lotteryContract.getPlayers(),
                    lotteryContract.currentWinner(), // This is the winner of the current/last round from contract state
                    lotteryContract.getContractTARABalance(),
                    lotteryContract.getIsOpenForEntries(),
                    lotteryContract.roundEndTime(),
                    lotteryContract.ownerFeesCollected(),
                    lotteryContract.owner()
                ]);

                // Store owner address for later checks
                contractOwnerAddress = contractOwner;

                lotteryIdSpan.textContent = lotteryId.toString();
                ticketPriceSpan.textContent = formatTARA(ticketPrice) + ' TARA';
                prizePoolSpan.textContent = formatTARA(contractBalance) + ' TARA';
                currentPrizePool.textContent = formatTARA(contractBalance) + ' TARA';
                currentPrizePoolUsd.textContent = formatUSD(formatTARA(contractBalance));

                numPlayersSpan.textContent = players.length.toString();

                // Update lottery status
                if (isOpenForEntries && (currentTimestamp < roundEndTime.toNumber())) {
                    lotteryStatusSpan.textContent = "Open for Entries";
                    lotteryStatusSpan.classList.remove('text-red-300', 'text-yellow-300');
                    lotteryStatusSpan.classList.add('text-green-300');
                } else if (!isOpenForEntries && contractCurrentWinner !== ethers.constants.AddressZero) {
                    lotteryStatusSpan.textContent = "Winner Picked (Round Closed)";
                    lotteryStatusSpan.classList.remove('text-green-300', 'text-yellow-300');
                    lotteryStatusSpan.classList.add('text-red-300');
                } else if (!isOpenForEntries && contractCurrentWinner === ethers.constants.AddressZero) {
                    lotteryStatusSpan.textContent = "Awaiting New Round Start";
                    lotteryStatusSpan.classList.remove('text-green-300', 'text-yellow-300');
                    lotteryStatusSpan.classList.add('text-red-300');
                } else if (currentTimestamp >= roundEndTime.toNumber() && isOpenForEntries) {
                    lotteryStatusSpan.textContent = "Ready for Draw";
                    lotteryStatusSpan.classList.remove('text-green-300', 'text-red-300');
                    lotteryStatusSpan.classList.add('text-yellow-300');
                } else {
                    lotteryStatusSpan.textContent = "Unknown";
                }


                // Calculate burn amount for next CHDPU burn (6% of ticket price per ticket)
                const burnPerTicket = ticketPrice.mul(6).div(100);
                burnAmountSpan.textContent = formatTARA(burnPerTicket) + ' TARA';

                // Update CHDPU rewards sent (placeholder, needs actual contract logic for this)
                const totalChdpuRewards = ethers.utils.parseEther("0"); // Placeholder
                chdpuRewardsSent.textContent = formatCHDPU(totalChdpuRewards) + ' CHDPU';
                chdpuRewardsSection.style.display = 'flex'; // Show this section

                // Countdown Timer
                if (roundEndTime.gt(currentTimestamp)) {
                    const remainingSeconds = roundEndTime.sub(currentTimestamp).toNumber();
                    let hours = Math.floor(remainingSeconds / 3600);
                    let minutes = Math.floor((remainingSeconds % 3600) / 60);
                    let seconds = remainingSeconds % 60;
                    countdownTimer.textContent = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
                } else {
                    countdownTimer.textContent = "Draw time reached!";
                }

                // Update header cumulative burn (placeholder, needs actual data)
                const cumulativeChdpuBurn = ethers.utils.parseEther("0"); // Placeholder
                headerCumulativeChdpu.textContent = formatCHDPU(cumulativeChdpuBurn) + ' CHDPU';
                headerCumulativeUsd.textContent = formatCHDPUUSD(formatCHDPU(cumulativeChdpuBurn));

                // Fetch and process past WinnerPicked events
                const winnerEvents = await lotteryContract.queryFilter("WinnerPicked");
                const pastWinners = [];
                let totalTaraPrizes = ethers.BigNumber.from(0);

                // Sort events by block number in descending order to get the latest first
                winnerEvents.sort((a, b) => b.blockNumber - a.blockNumber);

                let winnerForVisualizationAddress = ethers.constants.AddressZero;
                let winnerForVisualizationPrize = ethers.BigNumber.from(0);

                // Populate pastWinners array and calculate total prizes
                for (const event of winnerEvents) {
                    const winnerAddress = event.args._winner;
                    const prizeAmount = event.args._prizeAmount;
                    const lotteryRound = event.args._lotteryId.toNumber();

                    pastWinners.push({
                        lotteryRound: lotteryRound,
                        address: winnerAddress,
                        prize: prizeAmount
                    });
                    totalTaraPrizes = totalTaraPrizes.add(prizeAmount);

                    // If this event matches the current round's winner from contract state, use its prize for visualization
                    if (contractCurrentWinner !== ethers.constants.AddressZero &&
                        winnerAddress.toLowerCase() === contractCurrentWinner.toLowerCase() &&
                        event.args._lotteryId.eq(lotteryId)) {
                            winnerForVisualizationAddress = winnerAddress;
                            winnerForVisualizationPrize = prizeAmount;
                    }
                }

                console.log("Fetched and processed past winners from contract events:", pastWinners);
                console.log("Calculated cumulative TARA prizes:", totalTaraPrizes.toString());

                cumulativeTaraPrizes.textContent = formatTARA(totalTaraPrizes) + ' TARA';
                cumulativeTaraPrizesUsd.textContent = formatUSD(formatTARA(totalTaraPrizes));

                if (pastWinners.length > 0) {
                    const latestWinner = pastWinners[0]; // The latest winner overall
                    lastPrizeAmount.textContent = formatTARA(latestWinner.prize) + ' TARA';
                    lastPrizeWinner.textContent = `(${shortenAddress(latestWinner.address)})`;

                    // Display the winner of the *last completed round* from the events
                    currentWinnerSpan.textContent = shortenAddress(latestWinner.address);
                    currentWinnerAmountSpan.textContent = `(${formatTARA(latestWinner.prize)} TARA)`;
                } else {
                    lastPrizeAmount.textContent = 'N/A';
                    lastPrizeWinner.textContent = '';
                    currentWinnerSpan.textContent = 'N/A';
                    currentWinnerAmountSpan.textContent = '';
                }

                renderPastWinners(pastWinners);
                // Pass the specific winner and prize for the current round's visualization
                renderBallVisualization(players, winnerForVisualizationAddress, winnerForVisualizationPrize);

            } catch (error) {
                console.error("Error updating UI (Outer Catch):", error);
                if (error.code === 'NETWORK_ERROR') {
                    statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                    statusMessage.textContent = `Network Error: Could not connect to Taraxa RPC or contract. Please check your internet connection or try again later.`;
                } else {
                    statusMessage.textContent = `Error fetching DApp data: ${error.message}. Please refresh.`;
                    statusMessage.className = 'status bg-red-900 border-l-4 border-red-600 text-red-300 p-2.5 sm:p-3 rounded-md mb-4 sm:mb-5 shadow-inner text-sm';
                }
            }
        }

        // --- Render Past Winners List ---
        function renderPastWinners(winners) {
            pastWinnersContainer.innerHTML = ''; // Clear previous entries
            if (winners.length === 0) {
                noPastWinnersMessage.style.display = 'block';
                return;
            } else {
                noPastWinnersMessage.style.display = 'none';
            }

            winners.forEach(winner => {
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'bg-gray-600 p-2 rounded-md mb-2 text-gray-200 text-sm flex justify-between items-center';
                winnerDiv.innerHTML = `
                    <div>
                        <span class="font-bold text-green-300">Round ${winner.lotteryRound}:</span>
                        <span class="break-all ml-1">${shortenAddress(winner.address)}</span>
                    </div>
                    <span class="font-bold text-yellow-300">${formatTARA(winner.prize)} TARA</span>
                `;
                pastWinnersContainer.appendChild(winnerDiv);
            });
            console.log("Rendering past winners. Current pastWinners array:", winners);
        }

        // --- Lottery Visualization ---
        const ballColors = ['color-0', 'color-1', 'color-2', 'color-3', 'color-4', 'color-5'];

        function renderBallVisualization(players, winnerAddress, winnerPrize) { // Added winnerPrize argument
            ballArea.innerHTML = ''; // Clear previous balls
            winnerDisplay.innerHTML = ''; // Clear previous winner display
            visualizationMessage.style.display = 'none'; // Hide default message

            // Check if there's a winner to display for the current round
            if (winnerAddress && winnerAddress !== ethers.constants.AddressZero) {
                const winnerBall = document.createElement('div');
                winnerBall.className = 'winner-ball';
                winnerBall.innerHTML = `
                    <p>Winner!</p>
                    <span class="address">${shortenAddress(winnerAddress)}</span>
                    <span class="prize">${formatTARA(winnerPrize)} TARA</span>
                `;
                winnerDisplay.appendChild(winnerBall);
                return; // Exit as winner is displayed
            }

            // If no winner for the current round, display players or waiting message
            if (players.length === 0) {
                visualizationMessage.style.display = 'flex';
                visualizationMessage.textContent = "Waiting for players...";
                return;
            }

            // Create and position player balls
            players.forEach((player, index) => {
                const ball = document.createElement('div');
                ball.className = `ball ${ballColors[index % ballColors.length]}`;
                ball.style.left = `${Math.random() * (ballArea.offsetWidth - 60)}px`;
                ball.style.top = `${Math.random() * (ballArea.offsetHeight - 60)}px`;
                ball.style.setProperty('--x', ball.style.left);
                ball.style.setProperty('--y', ball.style.top);

                const ballContent = document.createElement('span');
                ballContent.className = 'ball-content';
                ballContent.textContent = shortenAddress(player);
                ball.appendChild(ballContent);
                ballArea.appendChild(ball);

                // Animate balls
                animateBall(ball);
            });
        }

        function animateBall(ball) {
            const maxX = ballArea.offsetWidth - ball.offsetWidth;
            const maxY = ballArea.offsetHeight - ball.offsetHeight;

            function moveBall() {
                const targetX = Math.random() * maxX;
                const targetY = Math.random() * maxY;

                ball.style.setProperty('--target-x', `${targetX}px`);
                ball.style.setProperty('--target-y', `${targetY}px`);

                const duration = Math.random() * 3 + 2; // 2-5 seconds
                ball.style.transition = `transform ${duration}s ease-in-out`;
                ball.style.transform = `translate(${targetX}px, ${targetY}px)`;

                setTimeout(moveBall, duration * 1000);
            }
            moveBall(); // Start initial movement
        }

        // --- Lottery Actions ---
        async function enterLottery() {
            if (!lotteryContract || !signer) {
                showNotification("Please connect your wallet first.", "error");
                return;
            }

            const numTickets = parseInt(numTicketsInput.value);
            if (isNaN(numTickets) || numTickets < 1 || numTickets > 10) {
                showNotification("Please enter a valid number of tickets (1-10).", "error");
                return;
            }

            showLoadingOverlay("Buying tickets...");
            try {
                const price = await lotteryContract.ticketPrice();
                const totalCost = price.mul(numTickets);

                const tx = await lotteryContract.enter(numTickets, { value: totalCost });
                await tx.wait(); // Wait for the transaction to be mined

                showNotification(`Successfully bought ${numTickets} ticket(s)!`, "success");
                await updateUI(); // Refresh UI after transaction
            } catch (error) {
                console.error("Error entering lottery:", error);
                showNotification(`Failed to buy tickets: ${error.message}`, "error");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function pickWinner() {
            if (!lotteryContract || !signer || currentAccount.toLowerCase() !== contractOwnerAddress.toLowerCase()) {
                showNotification("You are not authorized to pick a winner (Owner Only).", "error");
                return;
            }

            showLoadingOverlay("Picking winner...");
            try {
                const tx = await lotteryContract.pickWinner();
                await tx.wait();

                showNotification("Winner picked successfully!", "success");
                await updateUI();
            } catch (error) {
                console.error("Error picking winner:", error);
                showNotification(`Failed to pick winner: ${error.message}`, "error");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function startNewRound() {
            if (!lotteryContract || !signer || currentAccount.toLowerCase() !== contractOwnerAddress.toLowerCase()) {
                showNotification("You are not authorized to start a new round (Owner Only).", "error");
                return;
            }

            // You might want to get the round duration from an input or a predefined value
            const roundDurationSeconds = 120; // Example: 2 minutes for testing, adjust as needed

            showLoadingOverlay("Starting new round...");
            try {
                const tx = await lotteryContract.startNewRound(roundDurationSeconds);
                await tx.wait();

                showNotification("New lottery round started!", "success");
                await updateUI();
            } catch (error) {
                console.error("Error starting new round:", error);
                showNotification(`Failed to start new round: ${error.message}`, "error");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function collectOwnerFees() {
            if (!lotteryContract || !signer || currentAccount.toLowerCase() !== contractOwnerAddress.toLowerCase()) {
                showNotification("You are not authorized to collect fees (Owner Only).", "error");
                return;
            }

            showLoadingOverlay("Collecting owner fees...");
            try {
                const tx = await lotteryContract.collectOwnerFees();
                await tx.wait();

                showNotification("Owner fees collected successfully!", "success");
                await updateUI();
            } catch (error) {
                console.error("Error collecting fees:", error);
                showNotification(`Failed to collect fees: ${error.message}`, "error");
            } finally {
                hideLoadingOverlay();
            }
        }


        // --- Initialize on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initial UI update with placeholder data
            await updateUI();

            // Event Listeners
            connectWalletBtn.addEventListener('click', connectWallet);
            refreshDetailsBtn.addEventListener('click', updateUI);
            enterLotteryBtn.addEventListener('click', enterLottery);
            pickWinnerBtn.addEventListener('click', pickWinner);
            startNewRoundBtn.addEventListener('click', startNewRound);
            collectFeesBtn.addEventListener('click', collectOwnerFees);

            // Handle scroll to past winners
            document.getElementById('resultsOfLastDrawBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('pastWinnersList').scrollIntoView({ behavior: 'smooth' });
            });
            // Handle scroll to burn tracker
            document.querySelector('a[href="#burnTrackerSection"]').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('burnTrackerSection').scrollIntoView({ behavior: 'smooth' });
            });

            // Attempt to auto-connect if MetaMask is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });

        // Update countdown every second
        setInterval(async () => {
            if (lotteryContract && provider) { // Ensure provider is available
                try {
                    const block = await provider.getBlock("latest");
                    const currentTimestamp = block.timestamp;
                    const roundEndTime = await lotteryContract.roundEndTime();
                    if (roundEndTime.gt(currentTimestamp)) {
                        const remainingSeconds = roundEndTime.sub(currentTimestamp).toNumber();
                        let hours = Math.floor(remainingSeconds / 3600);
                        let minutes = Math.floor((remainingSeconds % 3600) / 60);
                        let seconds = remainingSeconds % 60;

                        countdownTimer.textContent = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
                    } else {
                        countdownTimer.textContent = "Draw time reached!";
                    }
                } catch (error) {
                    console.warn("Error in countdown interval:", error);
                    countdownTimer.textContent = "Error fetching time!";
                }
            }
        }, 1000);

        // Periodically refresh UI data (e.g., every 30 seconds)
        setInterval(updateUI, 30000);
    </script>
</body>
</html>
